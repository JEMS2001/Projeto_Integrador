CREATE TABLE empresa (
    id_empresa INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    cnpj VARCHAR(20),
    endereco VARCHAR(255),
    email VARCHAR(100),
    senha VARCHAR(100),
    imagem varchar(400);
);

CREATE TABLE membro (
    id_membro INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    data_nascimento DATE,
    telefone VARCHAR(20),
    cpf VARCHAR(14),
    email VARCHAR(100),
    senha VARCHAR(100),
    id_empresa INT,
    imagem varchar(400);
    FOREIGN KEY (id_empresa) REFERENCES empresa(id_empresa)
);

CREATE TABLE projeto (
    id_projeto INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    tipo VARCHAR(50),
    data_inicio DATE,
    data_fim DATE,
    id_empresa INT,
    FOREIGN KEY (id_empresa) REFERENCES empresa(id_empresa)
);

CREATE TABLE membro_projeto (
    id_membro INT,
    id_projeto INT,
    PRIMARY KEY (id_membro, id_projeto),
    FOREIGN KEY (id_membro) REFERENCES membro(id_membro),
    FOREIGN KEY (id_projeto) REFERENCES projeto(id_projeto)
);

CREATE TABLE tarefa (
    id_tarefa INT AUTO_INCREMENT primary key,
    nome varchar(100),
    descricao varchar(100),
    status varchar(100),
    id_membro INT,
    id_projeto INT,
    FOREIGN KEY (id_membro) REFERENCES membro(id_membro),
    FOREIGN KEY (id_projeto) REFERENCES projeto(id_projeto)
);

-- Modificação na tabela de membros para incluir o status de login
ALTER TABLE membro
ADD COLUMN esta_logado BOOLEAN DEFAULT FALSE,
ADD COLUMN ultimo_login DATETIME;

-- Nova tabela para registrar as sessões dos usuários
CREATE TABLE sessao_usuario (
    id_sessao INT AUTO_INCREMENT PRIMARY KEY,
    id_membro INT,
    data_inicio DATETIME NOT NULL,
    data_fim DATETIME,
    duracao_segundos INT,
    FOREIGN KEY (id_membro) REFERENCES membro(id_membro)
);

-- Índice para melhorar o desempenho das consultas
CREATE INDEX idx_membro_data ON sessao_usuario (id_membro, data_inicio);


-- Modificação na tabela tarefa
ALTER TABLE tarefa
ADD COLUMN nivel_dificuldade ENUM('Fácil', 'Médio', 'Difícil') NOT NULL,
ADD COLUMN tempo_estimado INT NOT NULL COMMENT 'Tempo estimado em dias',
ADD COLUMN data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP,
ADD COLUMN data_conclusao DATETIME;

-- Nova tabela para rastrear o progresso das tarefas
CREATE TABLE progresso_tarefa (
    id_progresso INT AUTO_INCREMENT PRIMARY KEY,
    id_tarefa INT,
    id_membro INT,
    status_anterior VARCHAR(100),
    status_novo VARCHAR(100),
    tempo_gasto INT COMMENT 'Tempo gasto em dias',
    data_atualizacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_tarefa) REFERENCES tarefa(id_tarefa),
    FOREIGN KEY (id_membro) REFERENCES membro(id_membro)
);

ALTER TABLE tarefa
CHANGE COLUMN tempo_estimado tempo_estimado INT NOT NULL COMMENT 'Tempo estimado em dias';


-- Índices para melhorar o desempenho
CREATE INDEX idx_tarefa_status ON tarefa (status);
CREATE INDEX idx_progresso_tarefa ON progresso_tarefa (id_tarefa, data_atualizacao);